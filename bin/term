#!/bin/bash
printf "\e]0;TERM\a\033kTERM\033\\"

FIFO=/tmp/term.$$.pipe
mkfifo ${FIFO}.fzf
mkfifo ${FIFO}.cut

fzf -d " " --with-nth=2.. <${FIFO}.fzf >${FIFO}.cut &
FZF_PID=$!

exec 3> ${FIFO}.fzf
exec 4< ${FIFO}.cut
unlink ${FIFO}.fzf
unlink ${FIFO}.cut

OPT_SEL=()
OIDX=0

function add_option() {
    DIS=$1
    shift 1

    if kill -0 $FZF_PID >/dev/null 2>&1 ; then
        echo $OIDX $DIS >&3
    else
        break
    fi
    OPT_SEL[$OIDX]=$@
    OIDX=$(expr $OIDX + 1)
}

function add_options() {
    TAG=$1
    SEL=$2
    shift 2
    CMD=$@

    while IFS='' read o ; do
        add_option "$TAG $o" $SEL "$o"
    done < <($CMD)
}

function add_tmux_windows() {
    while read id title ; do
        if [ "$title" != "TERM" ] ; then
            add_option "t $title" tmux_select $id
        fi
    done < <(tmux list-windows -F "#{window_id} #T")
}

function do_fzf() {
    exec 3>&- # Done with input to fzf
    read opt rest <&4
    exec 4<&- # Done with output from fzf
    
    if [ "$opt" != "" ] ; then
        ${OPT_SEL[$opt]}
    fi
}

# Selectors

function open_select() {
    opt=$(fzf)
    if [ "$opt" != "" ] ; then
        open $opt
    fi
}
function edit_select() {
    opt=$(fzf)
    if [ "$opt" != "" ] ; then
        $EDITOR $opt
    fi
}
function tmux_select() {
    tmux select-window -t $1
}
function dir_select() {
    DIR=$1
    tmux select-window -t $(tmux new-window -F '#{window_id}' -P -c "$DIR")
}
function file_select() {
    $EDITOR $1
}

# Configuration

# XXX add some "applications" like calendar, irc, todo, browser, etc

# XXX add my bookmarks, etc

# XXX remove these and make a new "open"-like command that calls
# $EDITOR or open depending on the file type

# XXX also, go through the whole cwd right away rather than putting it
# behind this
add_option "open" open_select
add_option "edit" edit_select
add_tmux_windows
add_options d dir_select recent-read dir
add_options f file_select recent-read file
do_fzf
