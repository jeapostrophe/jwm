#!/bin/bash
MODE=$1

FIFO=/tmp/term.$$.pipe
#mkfifo ${FIFO}.fzf
#mkfifo ${FIFO}.cut

#fzf -d " " --with-nth=2.. <${FIFO}.fzf >${FIFO}.cut &

OPT_SEL=()
OIDX=0

function add_option() {
    DIS=$1
    shift 1

    echo $OIDX $DIS >>${FIFO}.fzf
    OPT_SEL[$OIDX]=$@
    OIDX=$(expr $OIDX + 1)
}

function add_options() {
    TAG=$1
    SEL=$2
    shift 2
    CMD=$@

    while IFS='' read o ; do
        add_option "$TAG $o" $SEL "$o"
    done < <($CMD)
}

function add_tmux_windows() {
    while read id title ; do
        add_option "t $title" tmux_select $id
    done < <(tmux list-windows -F "#{window_id} #T")
}

function do_fzf() {
    opt=$(fzf -d " " --with-nth=2.. <${FIFO}.fzf | cut -d " " -f 1)
#    rm ${FIFO}.fzf
#    read opt rest <${FIFO}.cut
#    rm ${FIFO}.cut
    
    if [ "$opt" != "" ] ; then
        ${OPT_SEL[$opt]}
    fi
}

# Selectors

function open_select() {
    open $(fzf)
}
function edit_select() {
    $EDITOR $(fzf)
}
function tmux_select() {
    tmux select-window -t $1
}
function dir_select() {
    DIR=$1
    tmux select-window -t $(tmux new-window -F '#{window_id}' -P -c "$DIR")
}
function file_select() {
    $EDITOR $1
}

# Configuration

add_option "open" open_select
add_option "edit" edit_select
if [ "$MODE" != "new" ] ; then
    add_tmux_windows
fi
add_options d dir_select recent-read dir
add_options f file_select recent-read file
# XXX Do this early and send the results in to it (use fifo?)
do_fzf
